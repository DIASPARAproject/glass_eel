---
title: "glasseel_gam"
author: "Tessa van der Hammen"
date: "2025-09-03"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
datapath  <-"data"
if(Sys.info()[["user"]] == 'hamme0055'){
  setwd("C:/Tessa/glass_eel/R")
  datawd <- file.path(getwd(),datapath)
} else if (Sys.info()[["user"]] == 'cedric.briand'){
  setwd("C:/workspace/DIASPARA_glass_eel/R")
  datawd <- file.path(getwd(),datapath)
}
```

This script analyses glass eel size from different locations in Europe. We do a seasonal gam.
{>> this is a comment from CÃ©dric >>}

```{r Process data, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(lubridate)
library(mgcv)
library(dplyr)
library(ggplot2)
library(visreg)


# read in data
load(file = file.path(datawd, "dat.Rdata"))

don   <- dat

###
origin    <- as.numeric(as.Date(ymd(19600101)))
don$fi_date <- as.Date(don$fi_date2, format= "%Y-%m-%d")

don$yday=yday(don$fi_date) # yday is the season

don$doy=don$yday-305 # year begins in november
don$season<-paste0(year(don$fi_date)-1,"-",year(don$fi_date)) # year-1-year
don$time  <- as.numeric(as.Date(don$fi_date, format= "%Y-%m-%d")) - origin



nyears <- length(unique(don$fi_year))


```

1. make some exploratory plots with the raw data

```{r exploratory plots, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
knitr::opts_chunk$set(echo = FALSE)

# check for outliers
ggplot(don)+ geom_point(aes(x=fi_date, y=jitter(lengthmm)))+
  facet_wrap(~ser_nameshort, scales='free_y') +geom_smooth(aes(x=fi_date, y=jitter(lengthmm)))

ggplot(don)+ geom_point(aes(x=yday, y=jitter(lengthmm)))+
  facet_wrap(~ser_nameshort, scales='free_y') +geom_smooth(aes(x=yday, y=jitter(lengthmm)))

# make lf distribution
ggplot(don, aes(x=lengthmm)) +    
 geom_histogram(binwidth=1)+facet_wrap(~ser_nameshort, scales = "free_y")

```

Do some datacleaning. Remove american eels and dataset with very small amounts of data.Run model from 2000? before it is just Den Oever.

```{r datacleaning, include=FALSE}
# remove East_river (american eel)
#don <- don[!(don$ser_nameshort %in% 'East_River'),]

# remove datasets with little data
don <- don[!(don$ser_nameshort %in% c('BdareG', 'FealGY', 'InagG', 'MaigG', 'CorGY', 'BoyneGY','LiffGY', 'InagG', 'FealGY')),]

# remove outliers Den Oever
don <- don[!(don$ser_nameshort %in% 'RhDOG' & don$yday <75),]

# remove data before 2000?
#don <- don[dat$fi_year > 1999,]
#


```

run and check the gam model

```{r gam model}
# cr is standard cubic spline
# cc start and end at the same length (for seasonal)

don$ser_nameshort <- as.factor(don$ser_nameshort)

don1 <- don[, c("lengthmm", "ser_nameshort", "time", 'yday', 'fi_date')]
don1 <- don1[complete.cases(don1),]

g3.1 <- gam(lengthmm~ser_nameshort+s(yday,bs="cc", k=6) +
            s(time, bs = "cr", k =10),
               data=don1,
          family = gaussian)

summary(g3.1)
#gam.check(g3.1)

don1$res <- residuals(g3.1)
vis.gam(g3.1)
qq.gam(g3.1,rep=100,level=1,type="pearson",pch=19,cex=.2)

time1<-as.numeric(as.Date(ymd(20240101)))-origin

v2<-visreg(g3.1, xvar="time", cond= list(time = time1))

v1<-visreg(g3.1, xvar="yday", by= "ser_nameshort", cond= list(time = time1))
```

make plots gam model

```{r plots gam model, message=FALSE, warning=FALSE, paged.print=FALSE}

plot(g3.1, ylim=c(-10,10))

ggplot(don1) + 
  facet_wrap(~ser_nameshort, scales='free_y')+
  geom_smooth(aes(x=yday, y=res))

ggplot(don1) + 
  geom_point(aes(x=yday, y=res, color=ser_nameshort))+facet_wrap(~ser_nameshort)+
  geom_smooth(aes(x=yday, y=res))

predata <- data.frame(
  dates = rep(seq(as.Date('2000-01-01'), as.Date('2025-12-31'), by = 'days'), length(unique(don$ser_nameshort))),
  ser_nameshort = rep(unique(don$ser_nameshort), each=length(seq(as.Date('2000-01-01'), as.Date('2025-12-31'), by = 'days'))))
predata$time <- as.numeric(as.Date(predata$dates, format= "%Y-%m-%d")) - origin
predata$fi_year <- format(as.Date(predata$dates, format="%Y-%m-%d"), "%Y")
predata$yday=yday(predata$dates)
predata$fi_date <- as.Date(predata$dates, format="%Y-%m-%d")

pred <- predict(g3.1, newdata=predata,se.fit=TRUE)
predata$pred_length <- pred$fit
predata$pred_length_lwr <- pred$fit-1.96*pred$se.fit
predata$pred_length_upr <- pred$fit+1.96*pred$se.fit


ggplot(predata)+
  #geom_point(aes(x=fi_date,y=jitter(lengthmm)),col="#043C6B", data=don1)+
  geom_line(aes(x=fi_date,y=pred_length), col='red')+
  geom_ribbon(data=predata,aes(x=fi_date,ymin=pred_length_lwr,ymax=pred_length_upr, group=fi_year),alpha=0.3,fill="#BF8330")+
  theme_minimal()+
  facet_wrap(~ser_nameshort, scales='free_y')
  #ylim(0,100)


p2  <-  ggplot(predata) +
  geom_line(aes(x=yday,y=pred_length, group=fi_year, color=fi_year)) +
  theme_minimal() +
  theme(panel.border = element_blank(),
        axis.line = element_line()) +
  xlab("yday") +
  facet_wrap(~ser_nameshort)+
  ylim(63,80)
print(p2)


#plot(g3.1, rug = FALSE, se = FALSE, n2 = 80, main = "gam with t2")



```

```{r gam-specific_ge_stage}


```

```{r gam-model_DenOever}
# First select Den Oever data ------------------
unique(don$ser_nameshort)
donrhdo <- don |> filter(ser_nameshort == "RhDOG")
donrhdo <- donrhdo[, c("lengthmm", "ser_nameshort", "time", 'yday', 'fi_date', "season")]
donrhdo <- donrhdo[complete.cases(donrhdo),]

# less samples after
donrhdo |> 
  group_by(season,yday) |> 
  summarize(n=n()) |>
ggplot() + geom_point(aes(x= season, y =yday, size = n ))
donrhdo$season <- as.factor(donrhdo$season)

g0 <- gam(lengthmm~s(yday,bs="cc", k=6) +    
            s(time, bs = "cr", k =10),
               data=donrhdo,
          family = gaussian)
AIC(g0) # 437463.3 Deviance explained = 29.2%
# hierachical structure in the gam model - A general smooth and 
g1 <- gam(lengthmm~s(yday,bs="cc", k=6) + 
            s(yday,bs="cc", k=6, by = season) +
            s(time, bs = "cr", k =10),
               data=donrhdo,
          family = gaussian)
# AIC 431793.3 lower so better deviance explained 23.6%
nvar <- donrhdo |> distinct(season) |> nrow() + 2
# plot quickly seasonal trend
plot(g1, residuals = TRUE, se = TRUE, select = 1)

plot(g1, residuals = FALSE, se = TRUE, pages=1)
v2<-visreg(gamm_s,xvar="time")
v2$fit$time=as.Date(v2$fit$time, origin=as.Date(ymd(19970101)))
v2$res$time=as.Date(v2$res$time, origin=as.Date(ymd(19970101)))


```


```{r gam-model_all_together}



```


```{r gam-model_east_river}
# First select east river data ------------------
unique(don$ser_nameshort)
doner <- don |> filter(ser_nameshort == "East_River")
doner <- doner[, c("lengthmm", "ser_nameshort", "time", 'yday', 'fi_date', "season")]
doner <- doner[complete.cases(doner),]

# earlier samples later in the time series:
doner |> 
  group_by(season,yday) |> 
  summarize(n=n()) |>
ggplot() + geom_point(aes(x= season, y =yday, size = n ))
doner$season <- as.factor(doner$season)

g10 <- gam(lengthmm~s(yday,bs="cr", k=6) +    
            s(time, bs = "cr", k =10),
               data=doner,
          family = gaussian)
AIC(g10) # 206709.9 Deviance explained = 11.3%
summary(g10)

# hierachical structure in the gam model - A general smooth and 
g11 <- gam(lengthmm~s(yday,bs="cr", k=6) + 
            s(yday,bs="cr", k=6, by = season) +
            s(time, bs = "cr", k =10),
               data=doner,
          family = gaussian)
AIC(g11) # 203970.7 Deviance explained = 17.8%
summary(g11)

nvar <- doner |> distinct(season) |> nrow() + 2
# plot quickly seasonal trend
plot(g11, residuals = TRUE, se = TRUE, select = 1, ylim=c(-300,1000))

plot(g11, residuals = FALSE, se = TRUE, select=1,ylim=c(-300,1000))

v2$fit$time=as.Date(v2$fit$time, origin=as.Date(ymd(19970101)))
v2$res$time=as.Date(v2$res$time, origin=as.Date(ymd(19970101)))
v2<-visreg(g11,xvar="time")



```

